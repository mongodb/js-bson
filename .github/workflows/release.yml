on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write
  id-token: write

name: release

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - id: release
        uses: google-github-actions/release-please-action@v3
        with:
          release-type: node
          package-name: bson
          # Example: chore(main): release 5.7.0 [skip-ci]
          # ${scope} - parenthesis included, base branch name
          pull-request-title-pattern: 'chore${scope}: release ${version} [skip-ci]'
          pull-request-header: 'Please run the release_notes action before releasing to generate release highlights'
          changelog-path: HISTORY.md
          default-branch: main     

      # If release-please created a release, publish to npm
      - if: true
        run: echo 'secrets printing nowwww' ${{ secrets }}
      - if: true 
        uses: actions/checkout@v3
      - if: true
        name: actions/setup
        uses: ./.github/actions/setup
      - if: true
        name: Create, sign, and commit signed tarball
        uses: mongodb-labs/drivers-github-tools/garasign/git-sign@main
        with: 
          command: "$(pwd)/.github/workflows/create-sign-and-commit-tarball.sh ${{ env.PACKAGE_VERSION }} ${{ vars.GPG_KEY_ID }}"
          garasign_username: ${{ secrets.GRS_CONFIG_USER1_USERNAME }}
          garasign_password: ${{ secrets.GRS_CONFIG_USER1_PASSWORD }}
          artifactory_username: ${{ secrets.ARTIFACTORY_USER }}
          artifactory_password: ${{ secrets.ARTIFACTORY_PASSWORD }}  
      - if: true
        run: echo 'done'
        #run: npm publish --provenance
        #env:
          #NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
